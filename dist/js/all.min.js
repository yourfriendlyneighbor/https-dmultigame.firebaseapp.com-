var config={apiKey:"AIzaSyDVE_5l-xC3-i0Q9Tzbi_4ij2nD5o7uDD0",authDomain:"dmultigame.firebaseapp.com",databaseURL:"https://dmultigame.firebaseio.com",projectId:"dmultigame",storageBucket:"dmultigame.appspot.com",messagingSenderId:"693946145913"};firebase.initializeApp(config);var fbRef=firebase.database().ref("data");
THREE.PlayerControls=function(a,e,p){function m(){return 2*Math.PI/60/60*d.autoRotateSpeed}function g(c){!1!==d.enabled&&(c.preventDefault(),q===l.ROTATE?(u.set(c.clientX,c.clientY),v.subVectors(u,w),d.rotateLeft(2*Math.PI*v.x/1800*d.userRotateSpeed),d.rotateUp(2*Math.PI*v.y/1800*d.userRotateSpeed),w.copy(u)):q===l.ZOOM&&(b.set(c.clientX,c.clientY),B.subVectors(b,t),0<B.y?d.zoomIn():d.zoomOut(),t.copy(b)))}function x(c){!1!==d.enabled&&!1!==d.userRotate&&(document.removeEventListener("mousemove",
g,!1),document.removeEventListener("mouseup",x,!1),q=l.NONE)}function n(c){if(!1!==d.enabled&&!1!==d.userRotate){var a=0;c.wheelDelta?a=c.wheelDelta:c.detail&&(a=-c.detail);0<a?d.zoomOut():d.zoomIn()}}this.camera=a;this.player=e;this.domElement=void 0!==p?p:document;this.enabled=!0;this.center=new THREE.Vector3(e.position.x,e.position.y,e.position.z);this.moveSpeed=.2;this.turnSpeed=.1;this.userZoom=!0;this.userZoomSpeed=1;this.userRotate=!0;this.userRotateSpeed=1.5;this.autoRotate=!1;this.autoRotateSpeed=
.1;this.YAutoRotation=!1;this.minPolarAngle=0;this.maxPolarAngle=Math.PI;this.minDistance=0;this.maxDistance=75;var d=this,w=new THREE.Vector2,u=new THREE.Vector2,v=new THREE.Vector2,t=new THREE.Vector2,b=new THREE.Vector2,B=new THREE.Vector2,h=0,y=0,z=1,A=new THREE.Vector3(e.position.x,e.position.y,e.position.z),k=!1,f={},l={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},q=l.NONE;this.rotateLeft=function(c){void 0===c&&(c=m());y-=c};this.rotateRight=function(c){void 0===c&&(c=m());y+=c};this.rotateUp=function(c){void 0===
c&&(c=m());h-=c};this.rotateDown=function(c){void 0===c&&(c=m());h+=c};this.zoomIn=function(c){void 0===c&&(c=Math.pow(.95,d.userZoomSpeed));z/=c};this.zoomOut=function(c){void 0===c&&(c=Math.pow(.95,d.userZoomSpeed));z*=c};this.init=function(){this.camera.position.x=this.player.position.x+2;this.camera.position.y=this.player.position.y+2;this.camera.position.z=this.player.position.x+2;this.camera.lookAt(this.player.position)};this.update=function(){this.checkKeyStates();this.center=this.player.position;
var c=this.camera.position,a=c.clone().sub(this.center),b=Math.atan2(a.x,a.z),d=Math.atan2(Math.sqrt(a.x*a.x+a.z*a.z),a.y),b=b+y,d=d+h,d=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,d)),d=Math.max(1E-6,Math.min(Math.PI-1E-6,d)),f=a.length()*z,f=Math.max(this.minDistance,Math.min(this.maxDistance,f));a.x=f*Math.sin(d)*Math.sin(b);a.y=f*Math.cos(d);a.z=f*Math.sin(d)*Math.cos(b);this.autoRotate?(this.camera.position.x+=this.autoRotateSpeed*(this.player.position.x+8*Math.sin(this.player.rotation.y)-
this.camera.position.x),this.camera.position.z+=this.autoRotateSpeed*(this.player.position.z+8*Math.cos(this.player.rotation.y)-this.camera.position.z)):c.copy(this.center).add(a);this.camera.lookAt(this.center);h=y=0;z=1;this.autoRotate=q===l.NONE&&k?!0:!1;0<A.distanceTo(this.player.position)?A.copy(this.player.position):0==A.distanceTo(this.player.position)&&(k=!1)};this.checkKeyStates=function(){if(f[38]||f[87])this.player.position.x-=this.moveSpeed*Math.sin(this.player.rotation.y),this.player.position.z-=
this.moveSpeed*Math.cos(this.player.rotation.y),this.camera.position.x-=this.moveSpeed*Math.sin(this.player.rotation.y),this.camera.position.z-=this.moveSpeed*Math.cos(this.player.rotation.y);if(f[40]||f[83])k=!0,this.player.position.x+=this.moveSpeed*Math.sin(this.player.rotation.y),this.player.position.z+=this.moveSpeed*Math.cos(this.player.rotation.y),this.camera.position.x+=this.moveSpeed*Math.sin(this.player.rotation.y),this.camera.position.z+=this.moveSpeed*Math.cos(this.player.rotation.y);
if(f[37]||f[65])k=!0,this.player.rotation.y+=this.turnSpeed;if(f[39]||f[68])k=!0,this.player.rotation.y-=this.turnSpeed;f[81]&&(k=!0,this.player.position.x-=this.moveSpeed*Math.cos(this.player.rotation.y),this.player.position.z+=this.moveSpeed*Math.sin(this.player.rotation.y),this.camera.position.x-=this.moveSpeed*Math.cos(this.player.rotation.y),this.camera.position.z+=this.moveSpeed*Math.sin(this.player.rotation.y));f[69]&&(k=!0,this.player.position.x+=this.moveSpeed*Math.cos(this.player.rotation.y),
this.player.position.z-=this.moveSpeed*Math.sin(this.player.rotation.y),this.camera.position.x+=this.moveSpeed*Math.cos(this.player.rotation.y),this.camera.position.z-=this.moveSpeed*Math.sin(this.player.rotation.y));fbRef.child("Players/"+pid+"/orientation").update({position:{x:this.player.position.x,y:this.player.position.y,z:this.player.position.z},rotation:{x:this.player.rotation.x,y:this.player.rotation.y,z:this.player.rotation.z}})};this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},
!1);this.domElement.addEventListener("mousedown",function(a){!1!==d.enabled&&!1!==d.userRotate&&(a.preventDefault(),0===a.button?(q=l.ROTATE,w.set(a.clientX,a.clientY)):1===a.button&&(q=l.ZOOM,t.set(a.clientX,a.clientY)),document.addEventListener("mousemove",g,!1),document.addEventListener("mouseup",x,!1))},!1);this.domElement.addEventListener("mousewheel",n,!1);this.domElement.addEventListener("DOMMouseScroll",n,!1);this.domElement.addEventListener("keydown",function(a){a=a||window.event;f[a.keyCode||
a.which]=!0},!1);this.domElement.addEventListener("keyup",function(a){a=a||window.event;f[a.keyCode||a.which]=!1},!1)};THREE.PlayerControls.prototype=Object.create(THREE.EventDispatcher.prototype);
var Player=function(a,e){this.pid=a;this.isMainPlayer=!1;this.mesh;this.color=e;var p=new THREE.BoxGeometry(1,1,1),m=new THREE.MeshBasicMaterial({color:this.color,wireframe:!1}),g=this;this.init=function(){g.mesh=new THREE.Mesh(p,m);scene.add(g.mesh);g.isMainPlayer&&(controls=new THREE.PlayerControls(camera,g.mesh),controls.init())};this.setOrientation=function(a,e){g.mesh&&(g.mesh.position.copy(a),g.mesh.rotation.x=e.x,g.mesh.rotation.y=e.y,g.mesh.rotation.z=e.z)}},otherPlayers={},pid,color,player;
function loadGame(){loadEnvironment();initMainPlayer();listenToOtherPlayers();window.onunload=function(){fbRef.child("Players/"+pid).remove()};window.onbeforeunload=function(){fbRef.child("Players/"+pid).remove()}}function listenToPlayer(a){a.val()&&otherPlayers[a.key].setOrientation(a.val().orientation.position,a.val().orientation.rotation)}
function listenToOtherPlayers(){fbRef.child("Players").on("child_added",function(a){a.val()&&pid!=a.key&&!otherPlayers[a.key]&&(otherPlayers[a.key]=new Player(a.key,a.val().orientation.color),otherPlayers[a.key].init(),fbRef.child("Players/"+a.key).on("value",listenToPlayer))});fbRef.child("Players").on("child_removed",function(a){a.val()&&(fbRef.child("Players/"+a.key).off("value",listenToPlayer),scene.remove(otherPlayers[a.key].mesh),delete otherPlayers[a.key])})}
function initMainPlayer(){pid=fbRef.child("Players").push().key;color=(r=document.cookie.replace(/(?:(?:^|.*;\s*)color\s*\=\s*([^;]*).*$)|^.*$/,"$1"))||"rgba(0,0,0)";fbRef.child("Players/"+pid+"/orientation").set({position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},color:r||"rgba(0,0,0)"});player=new Player(pid,color);player.isMainPlayer=!0;player.init()}
function loadEnvironment(){var a=new THREE.SphereGeometry(1),e=new THREE.MeshBasicMaterial({color:"rgb(255, 255, 0)"}),a=new THREE.Mesh(a,e);scene.add(a)}var container,scene,camera,renderer,controls;init();animate();
function init(){container=document.getElementById("container");scene=new THREE.Scene;camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,1,1E3);camera.position.z=5;renderer=new THREE.WebGLRenderer({alpha:!0});renderer.setSize(window.innerWidth,window.innerHeight);firebase.auth().onAuthStateChanged(function(a){a?(pid=a.uid,loadGame()):firebase.auth().signInAnonymously()["catch"](function(a){console.error(a.code+":"+a.message)})});window.addEventListener("resize",onWindowResize,
!1);container.appendChild(renderer.domElement);document.body.appendChild(container)}function animate(){requestAnimationFrame(animate);controls&&controls.update();render()}function render(){renderer.clear();renderer.render(scene,camera)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)}
var Modal=function(){var a=document.querySelectorAll(".modal__trigger"),e=document.querySelectorAll(".modal"),p=document.querySelectorAll(".modal__bg"),m=document.querySelectorAll(".modal__content"),g=document.querySelectorAll(".modal__close"),x=window,n=!1,d=a.length,w=function(a){a.preventDefault();a=this.dataset.modal;a=a.substring(1,a.length);a=document.getElementById(a);if(null===document.getElementById("modal__temp")){var b=document.createElement("div");b.id="modal__temp";this.appendChild(b);
u(this,a,b)}},u=function(a,d,e){var b=a.getBoundingClientRect(),g=d.querySelector(".modal__content").getBoundingClientRect(),h=x.innerWidth/2,k=x.innerHeight/2;a.classList.add("modal__trigger--active");var f=g.width/b.width,l=g.height/b.height,f=f.toFixed(3),l=l.toFixed(3),h=Math.round(h-b.left-b.width/2),k=Math.round(k-b.top-b.height/2);d.classList.contains("modal--align-top")&&(k=Math.round(g.height/2+g.top-b.top-b.height/2));a.style.transform="translate("+h+"px, "+k+"px)";a.style.webkitTransform=
"translate("+h+"px, "+k+"px)";e.style.transform="scale("+f+","+l+")";e.style.webkitTransform="scale("+f+","+l+")";window.setTimeout(function(){window.requestAnimationFrame(function(){v(d,e)})},400)},v=function(a,d){function b(){d.style.opacity="0";e.removeEventListener("transitionend",b,!1)}if(!n){var e=a.querySelector(".modal__content");a.classList.add("modal--active");e.classList.add("modal__content--active");e.addEventListener("transitionend",b,!1);n=!0}},t=function(b){function g(){setTimeout(function(){window.requestAnimationFrame(function(){h.remove()})},
350)}b.preventDefault();b.stopImmediatePropagation();b=b.target;var h=document.getElementById("modal__temp");if(n&&b.classList.contains("modal__bg")||b.classList.contains("modal__close")){h.style.opacity="1";h.removeAttribute("style");for(b=0;b<d;b++)e[b].classList.remove("modal--active"),m[b].classList.remove("modal__content--active"),a[b].style.transform="none",a[b].style.webkitTransform="none",a[b].classList.remove("modal__trigger--active");h.addEventListener("transitionend",g,!1);n=!1}};return{init:function(){for(var b=
0;b<d;b++)a[b].addEventListener("click",w,!1),g[b].addEventListener("click",t,!1),p[b].addEventListener("click",t,!1)}}}();Modal.init();function s(a){fbRef.child("Players/"+pid).remove();document.cookie="color="+a;window.location=window.location}
var materials=[createMaterial("images/sky.png"),createMaterial("images/sky.png"),createMaterial("images/sky.png"),createMaterial("images/ground.png"),createMaterial("images/sky.png"),createMaterial("images/sky.png")],mesh=new THREE.Mesh(new THREE.BoxGeometry(100,100,100,1,1,1),new THREE.MeshFaceMaterial(materials));mesh.scale.set(-1,1,1);scene.add(mesh);function createMaterial(a){a=THREE.ImageUtils.loadTexture(a);return new THREE.MeshBasicMaterial({map:a,overdraw:.5})}var hidden,visibilityChange;
"undefined"!==typeof document.hidden?(hidden="hidden",visibilityChange="visibilitychange"):"undefined"!==typeof document.mozHidden?(hidden="mozHidden",visibilityChange="mozvisibilitychange"):"undefined"!==typeof document.msHidden?(hidden="msHidden",visibilityChange="msvisibilitychange"):"undefined"!==typeof document.webkitHidden&&(hidden="webkitHidden",visibilityChange="webkitvisibilitychange");document.addEventListener(visibilityChange,handleVisibilityChange,!1);
function handleVisibilityChange(){document.title=document[hidden]?"Where are you?":"3D Multiplayer game"};
